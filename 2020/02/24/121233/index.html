<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5"><title>Java 序列化 之 Serializable | blog</title><meta name="description" content="Java 序列化 之 Serializable"><meta name="author" content="zhuhui"><meta name="copyright" content="zhuhui"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin><link rel="preconnect" href="//busuanzi.ibruce.info"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Java 序列化 之 Serializable"><meta name="twitter:description" content="Java 序列化 之 Serializable"><meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/LHF1998/Blogger@master/img/default.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Java 序列化 之 Serializable"><meta property="og:url" content="http://9201314.club/2020/02/24/121233/"><meta property="og:site_name" content="blog"><meta property="og:description" content="Java 序列化 之 Serializable"><meta property="og:image" content="https://cdn.jsdelivr.net/gh/LHF1998/Blogger@master/img/default.jpg"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>const autoChangeMode = 'false'
var t = Cookies.get("theme");
if (autoChangeMode == '1'){
const isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
const isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
const isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

if (t === undefined){
  if (isLightMode) activateLightMode()
  else if (isDarkMode) activateDarkMode()
  else if (isNotSpecified || hasNoSupport){
    console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
    now = new Date();
    hour = now.getHours();
    isNight = hour < 6 || hour >= 18
    isNight ? activateDarkMode() : activateLightMode()
}
} else if (t == 'light') activateLightMode()
else activateDarkMode()


} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://9201314.club/2020/02/24/121233/"><link rel="next" title="Hello World" href="http://9201314.club/2020/02/24/hello-world/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    title: 'Snackbar.bookmark.title',
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime_unit: 'days',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  isHome: false,
  isPost: true
  
}</script><meta name="generator" content="Hexo 4.2.0"></head><body><header> <div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">blog</a></span><span class="toggle-menu pull_right close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/ZhuHui%20/"><i class="fa-fw ZhuHui"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></span></div></header><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/123.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">2</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">Categories</div><div class="length_num">1</div></a></div></div></div><hr><div class="menus_items"><div class="menus_item"><a class="site-page" href="/ZhuHui%20/"><i class="fa-fw ZhuHui"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-heart"></i><span> About</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-list" aria-hidden="true"></i><span> List</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-music"></i><span> Music</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> Movie</span></a></li></ul></div></div></div><div id="mobile-sidebar-toc"><div class="toc_mobile_headline">Catalog</div><div class="sidebar-toc__content"></div></div></div><div id="body-wrap"><div id="web_bg" data-type="photo"></div><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true">     </i><div class="auto_open" id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"></div></div></div><main id="content-outer"><div id="top-container" style="background-image: url(https://cdn.jsdelivr.net/gh/LHF1998/Blogger@master/img/default.jpg)"><div id="post-info"><div id="post-title"><div class="posttitle">Java 序列化 之 Serializable</div></div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> Created 2020-02-24<span class="post-meta__separator">|</span><i class="fa fa-history fa-fw" aria-hidden="true"></i> Updated 2020-02-24</time><span class="post-meta__separator">|</span><span><i class="fa fa-inbox post-meta__icon fa-fw" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/Java/">Java</a></span><div class="post-meta-wordcount"><div class="post-meta-pv-cv"><span><i class="fa fa-eye post-meta__icon fa-fw" aria-hidden="true"> </i>Post View:</span><span id="busuanzi_value_page_pv"></span></div></div></div></div></div><div class="layout layout_post" id="content-inner">   <article id="post"><div class="article-container" id="post-content"><p>概念<br>序列化：就是把对象转化成字节。<br>反序列化：把字节数据转换成对象。</p>
<p>对象序列化场景：<br>1、对象网络传输<br>例如：在微服务系统中或给第三方提供接口调用时，使用rpc进行调用，一般会把对象转化成字节序列，才能在网络上传输；接收方则需要把字节序列再转化为java对象。</p>
<p>2、对象保存至文件中<br>例如：hibernate中的二级缓存：把从数据库中查询出的对象，序列化转存到硬盘中，下次读取的时候，首先从内存中找是否有该对象，如果没有在去二级缓存（硬盘）中去查找。减少数据库的查询次数，提升性能。</p>
<p>3、tomcat的钝化和活化</p>
<p>tomcat 的session 钝化和活化之 StandarManager ：<br>当Tomcat服务器关闭或者重启时tomcat服务器会将当前内存中的session对象钝化到服务器文件系统中；<br>另一种情况是web应用程序被重新加载时(其实原理也是重启tomcat)，内存中的session对象也会被钝化到服务器的文件系统中<br>当系统启动时，会把序列化到硬盘上session重新加载到内存中来。这样用户还保持这登录状态，提供系统的可用性。<br>这样，tomcat重启，如果用户在tomcat重启之前登录过，然后在tomcat重启后可以不需要登录（前提是session没过期前，默认是30分钟过期）。</p>
<p>tomcat 的session 钝化和活化之 Persistentmanager：<br>当网站有大量用户访问的时候，服务器会创建大量的session，会占用大量的服务器内存资源，当用户开着浏览器一分钟不操作页面的话建议将session钝化，将session生成文件放在tomcat工作目录下。</p>
<p>可参考 : Tomcat 之 Session的活化和钝化 源码分析</p>
<ol>
<li>java 序列化 Serializable<br>java 中只要对象实现了 java.io.Serializable 就可以进行序列化。</li>
</ol>
<p>public class User implements Serializable {<br>    private String userName;<br>    private String password;<br>    private String addr;</p>
<pre><code>public String getUserName() {
    return userName;
}
public void setUserName(String userName) {
    this.userName = userName;
}
public String getPassword() {
    return password;
}
public void setPassword(String password) {
    this.password = password;
}
public String getAddr() {
    return addr;
}
public void setAddr(String addr) {
    this.addr = addr;
}
@Override
public String toString() {
    return &quot;User [userName=&quot; + userName + &quot;, password=&quot; + password + &quot;, addr=&quot; + addr + &quot;]&quot;;
}</code></pre><p>}<br>该 User 类实现了 Serializable 接口，那么该类应该怎么序列化和发序列化呢？</p>
<ol start="2">
<li>ObjectInputStream 和 ObjectOutputStream<br>Java IO 包中为我们提供了 ObjectInputStream 和 ObjectOutputStream 两个类。<br>java.io.ObjectOutputStream 类实现类的序列化功能。<br>java.io.ObjectInputStream 类实现了反序列化功能。</li>
</ol>
<p>示例如下：</p>
<p>public class Test{<br>    public static void main(String[] args) throws Exception {<br>        File file = new File(“d:\a.user”);<br>        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(file));<br>        User user1 = new User();<br>        user1.setUserName(“zhangsan”);<br>        user1.setPassword(“123456”);<br>        user1.setAddr(“北京中关村”);<br>        oos.writeObject(user1);</p>
<pre><code>    ObjectInputStream ois = new ObjectInputStream(new FileInputStream(file));
    User user2 = (User)ois.readObject();
    System.out.println(user2);
}</code></pre><p>}<br>输出结果：<br>User [userName=zhangsan, password=123456, addr=北京中关村]</p>
<p>使用 ObjectOutputStream 把 user1 实例序列化到 d:\user 文件中。<br>使用 ObjectInputStream 把 d:\user 文件中的数据反序列化成 user2 实，并打印。<br>如果考虑安全问题，我们不想把密码序列化进行保存，那么该怎么做呢？</p>
<ol start="3">
<li>transient关键字<br>当某个字段被声明为transient后，默认序列化机制就会忽略该字段。此处将User类中的password字段声明为transient，如下所示，</li>
</ol>
<p>public class User implements Serializable {<br>    private String userName;<br>    private transient String password;<br>    private String addr;<br>    … …<br>然后在执行Test类的 main 方法，执行结果如下：</p>
<p>输出结果：<br>User [userName=zhangsan, password=null, addr=北京中关村]</p>
<p>当我们把 User 对象序列化保存到文件中，这时 User 类结构添加了一个新字段，那么它能成功反序列化吗？</p>
<p>serialVersionUID的作用<br>User 类中添加一个新属性 email 字段，如下图：</p>
<p>然后再执行反序列化</p>
<p>执行结果如下：</p>
<p>Exception in thread “main” java.io.InvalidClassException: cn.com.infcn.serial.User; local class incompatible: stream classdesc serialVersionUID = 1318824539146791009, local class serialVersionUID = 7884536922902331245</p>
<p>执行反序列化报 java.io.InvalidClassException 异常。这是由于 User 类修改了，<br>也就是修改过后的class，不兼容了，处于安全机制考虑，程序抛出了错误，并且拒绝载入。从异常信息中可以看出，它是根据 serialVersionUID 值进行判断类是否修改过。</p>
<p>如果在添加新字段 email 后，还可以继续加载之前的字段怎么办呢？<br>我们可以在类中添加 serialVersionUID 属性字段。</p>
<p>serialVersionUID 的值和报错中的 “stream classdesc serialVersionUID” 的值一样就可以反序列化了。</p>
<p>如果类中没有显示的声明 serialVersionUID 属性，那么java编译器会自动为我们生成一个 serialVersionUID （应该是根据 属性和方法进行摘要算出来的，方法里面内容变动 serialVersionUID 的值不会改变。）</p>
<p>如果 User 对象升级版本，修改了结构，而且不想兼容之前的版本，那么只需要修改下 serialVersionUID 的值就可以了。</p>
<p>建议，每个需要序列化的对象，都要添加一个 serialVersionUID 字段。</p>
<p>如果需要把设置的 transient 的字段也需要序列化和发序列化，我们应该怎么办？我们需要对密码加密序列化，反序列化后解密处理，又应该怎么做？</p>
<p>readObject 和 writeObject</p>
<p>crypto 方法，实现加解密功能。<br>    /**<br>     * 简单加密加密解密字符串 加密解密思路：先将字符串变成byte数组，再将数组每位与key做位运算，得到新的数组就是加密或解密后的byte数组.<br>     * 知识：^ 是java位运算，可以百度了解下，a = b ^ skey 反之也成立，即b = a ^ skey<br>     *<br>     * @param str 解密/加密 字符串<br>     * @return<br>     * @throws Exception<br>     */<br>    static String crypto(String str) {<br>        try {<br>            byte skey = (byte) 88; //密钥<br>            byte[] bytes = str.getBytes(“GBK”);</p>
<pre><code>        for (int i = 0; i &lt; bytes.length; i++) {
            bytes[i] = (byte) (bytes[i] ^ skey);
        }
        return new String(bytes, &quot;GBK&quot;);
    } catch (Exception ex) {
        ex.printStackTrace();
    }
    return null;
}</code></pre><p>我们只需要在当前 User 类中添加 readObject() 和 writeObject() 方法，在 writeObject 方法中实现对 password 的字段加密，在 readObject 方法中实现对 password 字段解密，并赋值给 User 对象即可。</p>
<p>readObject() 和 writeObject() 可以实现对 transient 和 非transient字段进行序列化。</p>
<p>ArrayList 序列化源码分析<br>我们知道，ArrayList 是通过数组进行存储数据的，当数组中元素达到数组的最大容量时，会自动生成一个更大的数组，并复制到更大的数组中。</p>
<p>打开ArrayList 源码，我们可以知道，数据是存储在 Object[] elementData 数组中。<br>该属性是 transient 关键字修饰的，通过上面代码可以知道，用 transient 关键字修饰的字段，默认是不能被序列化的。ArrayList 如果要实现序列化，那么就必须通过 readObject() 和 writeObject() 方法去实现序列化，那么他这是多此一举吗？</p>
<p>writeObject() 方法</p>
<p>通过源码，我们可以看到，ArrayList 序列化数组元素时做了优化。<br>因为 ArrayList 的 elementData 数组大小，不是ArrayList 的实际容量，这里只把实际存储在 elementData中的数据，进行序列化。这样减少了序列化的流大小。</p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">zhuhui</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://9201314.club/2020/02/24/121233/">http://9201314.club/2020/02/24/121233/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank" rel="noopener">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/LHF1998/Blogger@master/img/default.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> Donate<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付寶"><div class="post-qr-code__desc">支付寶</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="next-post pull-full"><a href="/2020/02/24/hello-world/"><img class="next_cover lazyload" data-src="https://cdn.jsdelivr.net/gh/jerryc127/butterfly_cdn@2.1.0/top_img/default.png" onerror="onerror=null;src='/img/404.jpg'"><div class="label">Next Post</div><div class="next_info"><span>Hello World</span></div></a></div></nav></div></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2019 - 2020 By zhuhui</div><div class="framework-info"><span>Driven </span><a href="http://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div><div class="icp"><a href="http://beian.miit.gov.cn/" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"><span>备案号：粤ICP备17136383号-1</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="Read Mode"></i><i class="fa fa-plus" id="font_plus" title="Increase font size"></i><i class="fa fa-minus" id="font_minus" title="Decrease font size"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="Traditional Chinese and Simplified Chinese Conversion" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="Dark Mode"></i></div><div id="rightside-config-show"><div id="rightside_config" title="Setting"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="Table of Contents" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="Back to top" aria-hidden="true"></i></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script></body></html>